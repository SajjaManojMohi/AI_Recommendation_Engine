<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shop.</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --black:#111; --mid:#666; --light:#aaa; --xlight:#ddd;
  --border:#e8e8e8; --bg:#fff; --hover:#f7f7f7;
  --serif:'DM Serif Display',serif; --sans:'DM Sans',sans-serif;
  --r:5px; --cart-w:360px;
}

body { font-family:var(--sans); background:var(--bg); color:var(--black); min-height:100vh; overflow-x:hidden; }

/* NAV */
nav {
  position:sticky; top:0; z-index:50; background:#fff;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 40px; height:58px;
}
.nav-logo { font-family:var(--serif); font-size:1.5rem; letter-spacing:-.3px; }
.nav-right { display:flex; align-items:center; gap:10px; }
.nav-user  { font-size:.82rem; color:var(--mid); }
.nav-user strong { color:var(--black); font-weight:500; }

.btn-outline {
  border:1px solid var(--border); background:none; padding:7px 16px;
  border-radius:var(--r); font-family:var(--sans); font-size:.82rem;
  cursor:pointer; transition:background .12s;
}
.btn-outline:hover { background:var(--hover); }
.btn-solid {
  border:none; background:var(--black); color:#fff; padding:7px 16px;
  border-radius:var(--r); font-family:var(--sans); font-size:.82rem;
  cursor:pointer; transition:opacity .12s;
}
.btn-solid:hover { opacity:.82; }
.cart-btn {
  display:flex; align-items:center; gap:7px;
  border:1px solid var(--border); background:none; padding:7px 16px;
  border-radius:var(--r); font-family:var(--sans); font-size:.82rem;
  cursor:pointer; transition:background .12s;
}
.cart-btn:hover { background:var(--hover); }
.cart-badge {
  background:var(--black); color:#fff; border-radius:50%;
  width:18px; height:18px; font-size:.62rem;
  display:flex; align-items:center; justify-content:center; font-weight:600;
}

/* TABS */
.tab-bar {
  display:flex; border-bottom:1px solid var(--border);
  padding:0 40px; background:#fff;
}
.tab-btn {
  background:none; border:none; border-bottom:2px solid transparent;
  padding:13px 18px; font-family:var(--sans); font-size:.82rem; font-weight:500;
  cursor:pointer; color:var(--light); transition:all .13s; margin-bottom:-1px;
}
.tab-btn.active { color:var(--black); border-bottom-color:var(--black); }
.tab-btn:hover:not(.active) { color:var(--mid); }

/* MAIN */
main { padding:36px 40px 80px; max-width:1280px; margin:0 auto; }
.section-header { display:flex; align-items:baseline; justify-content:space-between; margin-bottom:18px; }
.section-title  { font-family:var(--serif); font-size:1.45rem; }
.section-meta   { font-size:.76rem; color:var(--light); }
.section-badge  { font-size:.7rem; padding:2px 9px; border:1px solid var(--border); border-radius:20px; color:var(--mid); text-transform:uppercase; letter-spacing:.05em; }

/* ROWS */
.h-row {
  display:flex; gap:14px; overflow-x:auto; padding-bottom:8px;
  scroll-snap-type:x mandatory; scrollbar-width:none; margin-bottom:44px;
}
.h-row::-webkit-scrollbar { display:none; }

/* CARD */
.card {
  flex:0 0 198px; border:1px solid var(--border); border-radius:6px;
  overflow:hidden; scroll-snap-align:start; background:#fff;
  transition:box-shadow .18s, transform .14s;
}
.card:hover { box-shadow:0 4px 22px rgba(0,0,0,.07); transform:translateY(-2px); }
.card.wide { flex:0 0 218px; }
.card-img  { width:100%; height:175px; object-fit:cover; background:#f2f2f2; display:block; }
.card-body { padding:11px 13px 14px; }
.card-brand{ font-size:.67rem; text-transform:uppercase; letter-spacing:.08em; color:var(--light); font-weight:500; margin-bottom:2px; }
.card-name { font-size:.84rem; font-weight:500; line-height:1.3; margin-bottom:5px; }
.card-cat  { display:inline-block; font-size:.63rem; padding:2px 7px; border:1px solid var(--border); border-radius:20px; color:var(--mid); text-transform:uppercase; letter-spacing:.04em; margin-bottom:7px; }
.card-price{ font-size:.9rem; font-weight:600; margin-bottom:9px; }
.card-add  {
  width:100%; padding:8px; background:var(--black); color:#fff;
  border:none; border-radius:var(--r); font-family:var(--sans);
  font-size:.76rem; font-weight:500; cursor:pointer; letter-spacing:.02em;
  transition:opacity .13s;
}
.card-add:hover { opacity:.82; }
.card-add.in-cart { background:#f0f0f0; color:var(--black); }

/* PURCHASED GRID */
.p-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:18px; }
.p-card { border:1px solid var(--border); border-radius:6px; overflow:hidden; }
.p-card .card-img { height:155px; }
.p-card .card-body { padding:11px 13px 15px; }
.star-row  { display:flex; gap:3px; margin-top:9px; }
.star      { background:none; border:none; font-size:1.08rem; cursor:pointer; color:#ddd; padding:0; line-height:1; transition:color .08s; }
.star.on   { color:#f4a940; }
.star-label{ font-size:.7rem; color:var(--light); margin-top:4px; }

/* AUTH MODAL */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.18);
  display:flex; align-items:center; justify-content:center;
  z-index:300; opacity:0; pointer-events:none; transition:opacity .22s;
}
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal-box {
  background:#fff; border-radius:8px; width:360px; padding:36px 36px 32px;
  box-shadow:0 8px 40px rgba(0,0,0,.12);
  transform:translateY(10px); transition:transform .22s;
}
.modal-overlay.open .modal-box { transform:translateY(0); }
.modal-tabs { display:flex; border-bottom:1px solid var(--border); margin-bottom:28px; }
.modal-tab  {
  flex:1; background:none; border:none; border-bottom:2px solid transparent;
  padding:10px; font-family:var(--sans); font-size:.85rem; font-weight:500;
  cursor:pointer; color:var(--light); margin-bottom:-1px; transition:all .13s;
}
.modal-tab.active { color:var(--black); border-bottom-color:var(--black); }
.field       { margin-bottom:14px; }
.field label { display:block; font-size:.72rem; letter-spacing:.07em; text-transform:uppercase; color:var(--mid); margin-bottom:5px; font-weight:500; }
.field input {
  width:100%; border:1px solid var(--border); border-radius:var(--r);
  padding:10px 13px; font-family:var(--sans); font-size:.88rem; outline:none;
  transition:border-color .15s;
}
.field input:focus { border-color:var(--black); }
.modal-hint   { font-size:.75rem; color:var(--xlight); margin-bottom:20px; }
.modal-hint em{ color:var(--mid); font-style:normal; }
.modal-submit {
  width:100%; padding:11px; background:var(--black); color:#fff;
  border:none; border-radius:var(--r); font-family:var(--sans);
  font-size:.88rem; font-weight:500; cursor:pointer; transition:opacity .13s;
}
.modal-submit:hover { opacity:.84; }
.modal-error  { color:#c00; font-size:.78rem; margin-top:10px; min-height:16px; }

/* CART */
.cart-overlay { position:fixed; inset:0; background:rgba(0,0,0,.15); z-index:200; display:none; }
.cart-overlay.open { display:block; }
.cart-panel   {
  position:fixed; right:0; top:0; bottom:0; width:var(--cart-w);
  background:#fff; border-left:1px solid var(--border);
  display:flex; flex-direction:column; z-index:201;
  transform:translateX(100%); transition:transform .25s cubic-bezier(.4,0,.2,1);
}
.cart-overlay.open .cart-panel { transform:translateX(0); }
.cart-head { padding:20px 22px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
.cart-head h2 { font-family:var(--serif); font-size:1.25rem; }
.cart-close   { background:none; border:none; font-size:1.3rem; cursor:pointer; color:var(--mid); }
.cart-close:hover { color:var(--black); }
.cart-items   { flex:1; overflow-y:auto; padding:14px 22px; }
.cart-empty   { text-align:center; color:var(--light); font-size:.84rem; padding:60px 0; }
.cart-item    { display:flex; gap:12px; padding:12px 0; border-bottom:1px solid var(--border); }
.cart-item:last-child { border:none; }
.ci-img  { width:60px; height:60px; object-fit:cover; border-radius:4px; flex-shrink:0; background:#f0f0f0; }
.ci-name { font-size:.83rem; font-weight:500; margin-bottom:3px; }
.ci-price{ font-size:.78rem; color:var(--mid); }
.ci-rm   { background:none; border:none; font-size:.72rem; color:var(--light); cursor:pointer; margin-top:5px; padding:0; }
.ci-rm:hover { color:#c00; }
.cart-foot       { padding:18px 22px; border-top:1px solid var(--border); }
.cart-total-row  { display:flex; justify-content:space-between; margin-bottom:14px; font-size:.88rem; }
.cart-total-row strong { font-weight:600; }
.checkout-btn    { width:100%; padding:12px; background:var(--black); color:#fff; border:none; border-radius:var(--r); font-family:var(--sans); font-size:.86rem; font-weight:500; cursor:pointer; transition:opacity .13s; }
.checkout-btn:hover { opacity:.84; }

/* MISC */
.empty-state { text-align:center; color:var(--light); padding:70px 0; font-size:.88rem; }
.loader      { text-align:center; color:var(--light); padding:40px 0; font-size:.84rem; letter-spacing:.05em; }
@keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }
.fade-up { animation:fadeUp .32s ease both; }
#page-purchased { display:none; }
#page-shop.hidden { display:none; }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <span class="nav-logo">AI Enabled Recommended Engine</span>
  <div class="nav-right" id="nav-right"></div>
</nav>

<!-- TABS -->
<div class="tab-bar">
  <button class="tab-btn active" onclick="showPage('shop',this)">Home</button>
  <button class="tab-btn" onclick="showPage('purchased',this)">Purchased</button>
</div>

<!-- SHOP PAGE -->
<div id="page-shop">
  <main>
    <div style="margin-bottom:48px">
      <div class="section-header">
        <span class="section-title">Recommended for you</span>
        <span class="section-meta" id="rec-meta"></span>
      </div>
      <div class="h-row" id="rec-row"><div class="loader">Loadingâ€¦</div></div>
    </div>
    <div id="cat-sections"></div>
  </main>
</div>

<!-- PURCHASED PAGE -->
<div id="page-purchased">
  <main>
    <div class="section-header" style="margin-bottom:26px">
      <span class="section-title">Your purchases</span>
    </div>
    <div class="p-grid" id="purchased-grid"></div>
    <div class="empty-state" id="purchased-empty" style="display:none">Nothing purchased yet.</div>
  </main>
</div>

<!-- AUTH MODAL -->
<div class="modal-overlay" id="auth-modal" onclick="modalBgClose(event)">
  <div class="modal-box">
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab('login',this)">Log in</button>
      <button class="modal-tab"        onclick="switchTab('signup',this)">Sign up</button>
    </div>
    <!-- Login -->
    <div id="tab-login">
      <div class="field"><label>User ID</label><input id="l-uid" type="text" placeholder="e.g. U0001"></div>
      <div class="field"><label>Password</label><input id="l-pwd" type="password" placeholder="any password for existing users"></div>
      <p class="modal-hint">Existing users: <em>U0001 â€“ U1000</em>, any password works.</p>
      <button class="modal-submit" onclick="doLogin()">Log in</button>
      <p class="modal-error" id="l-err"></p>
    </div>
    <!-- Signup -->
    <div id="tab-signup" style="display:none">
      <div class="field"><label>Choose a User ID</label><input id="s-uid" type="text" placeholder="e.g. MyUser42"></div>
      <div class="field"><label>Password</label><input id="s-pwd" type="password" placeholder="set a password"></div>
      <p class="modal-hint">Pick any ID not in U0001â€“U1000 range.</p>
      <button class="modal-submit" onclick="doSignup()">Create account</button>
      <p class="modal-error" id="s-err"></p>
    </div>
  </div>
</div>

<!-- CART -->
<div class="cart-overlay" id="cart-overlay" onclick="cartBgClose(event)">
  <div class="cart-panel">
    <div class="cart-head">
      <h2>Cart</h2>
      <button class="cart-close" onclick="closeCart()">âœ•</button>
    </div>
    <div class="cart-items" id="cart-body"></div>
    <div class="cart-foot">
      <div class="cart-total-row"><span>Total</span><strong id="cart-total">â‚¹0</strong></div>
      <button class="checkout-btn" onclick="checkout()">Buy now</button>
    </div>
  </div>
</div>

<script>
const API = "http://localhost:5000";
const CATEGORIES = ["Electronics","Fashion","Home","Beauty","Sports"];

let currentUser = null;
let isNewUser   = false;
let cart        = [];
let purchased   = [];
let sessionRatings = {};

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener("DOMContentLoaded", () => {
  renderNav();
  loadRecommendations();
  loadCategoryRows();
});

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNav() {
  const el = document.getElementById("nav-right");
  if (currentUser) {
    el.innerHTML = `
      <span class="nav-user">Hi, <strong>${currentUser}</strong></span>
      <button class="cart-btn" onclick="openCart()">ðŸ›’ Cart <span class="cart-badge" id="cart-badge">${cart.length}</span></button>
      <button class="btn-outline" onclick="doLogout()">Sign out</button>`;
  } else {
    el.innerHTML = `
      <button class="cart-btn" onclick="openCart()">ðŸ›’ Cart <span class="cart-badge" id="cart-badge">${cart.length}</span></button>
      <button class="btn-outline" onclick="openModal('login')">Log in</button>
      <button class="btn-solid"  onclick="openModal('signup')">Sign up</button>`;
  }
}

function updateBadge() {
  const b = document.getElementById("cart-badge");
  if (b) b.textContent = cart.length;
}

// â”€â”€ AUTH MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(tab) { switchTab(tab); document.getElementById("auth-modal").classList.add("open"); }
function closeModal()   { document.getElementById("auth-modal").classList.remove("open"); document.getElementById("l-err").textContent=""; document.getElementById("s-err").textContent=""; }
function modalBgClose(e){ if(e.target.id==="auth-modal") closeModal(); }

function switchTab(tab, btn) {
  document.getElementById("tab-login").style.display  = tab==="login"  ? "" : "none";
  document.getElementById("tab-signup").style.display = tab==="signup" ? "" : "none";
  document.querySelectorAll(".modal-tab").forEach(b => b.classList.remove("active"));
  if (btn) { btn.classList.add("active"); }
  else { document.querySelectorAll(".modal-tab")[tab==="login"?0:1].classList.add("active"); }
}

async function doLogin() {
  const uid = document.getElementById("l-uid").value.trim().toUpperCase();
  const pwd = document.getElementById("l-pwd").value.trim();
  const err = document.getElementById("l-err");
  if (!uid||!pwd) { err.textContent="Fill in both fields."; return; }
  try {
    const res  = await fetch(`${API}/api/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:uid,password:pwd})});
    const data = await res.json();
    if (!res.ok) { err.textContent=data.error; return; }
    currentUser=data.user_id; isNewUser=data.is_new;
    cart=[]; purchased=[]; sessionRatings={};
    closeModal(); renderNav(); loadRecommendations();
  } catch { err.textContent="Cannot reach server. Is app.py running?"; }
}

async function doSignup() {
  const uid = document.getElementById("s-uid").value.trim().toUpperCase();
  const pwd = document.getElementById("s-pwd").value.trim();
  const err = document.getElementById("s-err");
  if (!uid||!pwd) { err.textContent="Fill in both fields."; return; }
  try {
    const res  = await fetch(`${API}/api/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:uid,password:pwd})});
    const data = await res.json();
    if (!res.ok) { err.textContent=data.error; return; }
    currentUser=data.user_id; isNewUser=true;
    cart=[]; purchased=[]; sessionRatings={};
    closeModal(); renderNav(); loadRecommendations();
  } catch { err.textContent="Cannot reach server. Is app.py running?"; }
}

function doLogout() {
  currentUser=null; isNewUser=false;
  cart=[]; purchased=[]; sessionRatings={};
  renderNav(); loadRecommendations();
}

document.getElementById("l-uid").onkeydown = e => { if(e.key==="Enter") doLogin(); };
document.getElementById("l-pwd").onkeydown = e => { if(e.key==="Enter") doLogin(); };
document.getElementById("s-uid").onkeydown = e => { if(e.key==="Enter") doSignup(); };
document.getElementById("s-pwd").onkeydown = e => { if(e.key==="Enter") doSignup(); };

// â”€â”€ RECOMMENDATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRecommendations() {
  const row  = document.getElementById("rec-row");
  const meta = document.getElementById("rec-meta");
  row.innerHTML = '<div class="loader">Loadingâ€¦</div>';

  const url = currentUser
    ? `${API}/api/recommendations?user_id=${encodeURIComponent(currentUser)}&top_n=14`
    : `${API}/api/recommendations?top_n=14`;

  const METHOD_LABEL = {
    svd:        "Personalised Â· SVD model",
    item_based: "Item-based picks",
    user_based: "Users like you",
    popular:    "Trending right now"
  };

  try {
    const data = await fetch(url).then(r=>r.json());
    meta.textContent = METHOD_LABEL[data.method] || "";
    row.innerHTML = "";
    (data.recommendations||[]).forEach((p,i)=>{
      const card = makeCard(p,true);
      card.style.animationDelay = `${i*35}ms`;
      card.classList.add("fade-up");
      row.appendChild(card);
    });
    if (!row.children.length) row.innerHTML='<div class="loader">No recommendations.</div>';
  } catch {
    row.innerHTML='<div class="loader">Backend offline â€” run app.py first.</div>';
    meta.textContent="";
  }
}

// â”€â”€ CATEGORY ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCategoryRows() {
  const container = document.getElementById("cat-sections");
  container.innerHTML = "";

  for (const cat of CATEGORIES) {
    const section = document.createElement("div");
    section.innerHTML = `
      <div class="section-header">
        <span class="section-title">${cat}</span>
        <span class="section-badge">${cat.toLowerCase()}</span>
      </div>
      <div class="h-row" id="cat-${cat}"><div class="loader">Loadingâ€¦</div></div>`;
    container.appendChild(section);

    fetch(`${API}/api/products?category=${encodeURIComponent(cat)}&per_page=20`)
      .then(r=>r.json())
      .then(data=>{
        const row = document.getElementById(`cat-${cat}`);
        row.innerHTML="";
        (data.products||[]).forEach(p=>row.appendChild(makeCard(p,false)));
      })
      .catch(()=>{ document.getElementById(`cat-${cat}`).innerHTML='<div class="loader">â€“</div>'; });
  }
}

// â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeCard(p, wide) {
  const inCart = cart.some(c=>c.product.product_id===p.product_id);
  const div = document.createElement("div");
  div.className = `card${wide?" wide":""}`;
  div.innerHTML = `
    <img class="card-img" src="${p.image_url}" alt="${p.product_name}" loading="lazy"
         onerror="this.style.background='#eee';this.removeAttribute('src')">
    <div class="card-body">
      <div class="card-brand">${p.brand}</div>
      <div class="card-name">${p.product_name}</div>
      <div class="card-cat">${p.category}</div>
      <div class="card-price">â‚¹${Number(p.price).toLocaleString()}</div>
      <button class="card-add${inCart?" in-cart":""}" data-pid="${p.product_id}">
        ${inCart?"âœ“ In cart":"Add to cart"}
      </button>
    </div>`;
  div.querySelector(".card-add").addEventListener("click", e=>{
    e.stopPropagation(); addToCart(p);
  });
  return div;
}

function refreshButtons(pid) {
  const inCart = cart.some(c=>c.product.product_id===pid);
  document.querySelectorAll(`.card-add[data-pid="${pid}"]`).forEach(btn=>{
    btn.textContent = inCart ? "âœ“ In cart" : "Add to cart";
    btn.classList.toggle("in-cart", inCart);
  });
}

// â”€â”€ CART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addToCart(product) {
  if (cart.some(c=>c.product.product_id===product.product_id)) return;
  cart.push({product}); updateBadge(); renderCartBody();
}

function removeFromCart(pid) {
  cart=cart.filter(c=>c.product.product_id!==pid);
  updateBadge(); renderCartBody(); refreshButtons(pid);
}

function renderCartBody() {
  const el = document.getElementById("cart-body");
  if (!cart.length) {
    el.innerHTML='<div class="cart-empty">Your cart is empty.</div>';
    document.getElementById("cart-total").textContent="â‚¹0"; return;
  }
  el.innerHTML=cart.map(c=>`
    <div class="cart-item">
      <img class="ci-img" src="${c.product.image_url}" alt=""
           onerror="this.style.background='#eee';this.removeAttribute('src')">
      <div>
        <div class="ci-name">${c.product.product_name}</div>
        <div class="ci-price">â‚¹${Number(c.product.price).toLocaleString()}</div>
        <button class="ci-rm" onclick="removeFromCart('${c.product.product_id}')">Remove</button>
      </div>
    </div>`).join("");
  const total=cart.reduce((s,c)=>s+Number(c.product.price),0);
  document.getElementById("cart-total").textContent=`â‚¹${total.toLocaleString()}`;
}

function openCart()    { renderCartBody(); document.getElementById("cart-overlay").classList.add("open"); document.body.style.overflow="hidden"; }
function closeCart()   { document.getElementById("cart-overlay").classList.remove("open"); document.body.style.overflow=""; }
function cartBgClose(e){ if(e.target.id==="cart-overlay") closeCart(); }

async function checkout() {
  if (!cart.length) return;
  for (const c of cart) {
    const pid = c.product.product_id;
    if (!purchased.some(p=>p.product.product_id===pid))
      purchased.push({product:c.product, rating:sessionRatings[pid]||0});
    if (currentUser && isNewUser) {
      await fetch(`${API}/api/interact`,{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({user_id:currentUser,product_id:pid,rating:5})}).catch(()=>{});
    }
  }
  cart=[]; updateBadge(); renderCartBody(); closeCart(); renderPurchased();
  setTimeout(()=>loadRecommendations(), 400);
}

// â”€â”€ PURCHASED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPurchased() {
  const grid=document.getElementById("purchased-grid");
  const empty=document.getElementById("purchased-empty");
  if (!purchased.length) { grid.innerHTML=""; empty.style.display="block"; return; }
  empty.style.display="none";
  grid.innerHTML=purchased.map(item=>{
    const p=item.product; const r=sessionRatings[p.product_id]||0;
    const stars=[1,2,3,4,5].map(n=>`<button class="star${r>=n?" on":""}" onclick="rate('${p.product_id}',${n})">â˜…</button>`).join("");
    return `
      <div class="p-card">
        <img class="card-img" src="${p.image_url}" alt=""
             onerror="this.style.background='#eee';this.removeAttribute('src')">
        <div class="card-body">
          <div class="card-brand">${p.brand}</div>
          <div class="card-name">${p.product_name}</div>
          <div class="card-price">â‚¹${Number(p.price).toLocaleString()}</div>
          <div class="star-row" id="sr-${p.product_id}">${stars}</div>
          <div class="star-label" id="sl-${p.product_id}">${r?`Rated ${r}/5`:"Rate this product"}</div>
        </div>
      </div>`;
  }).join("");
}

async function rate(pid, rating) {
  sessionRatings[pid]=rating;
  const sr=document.getElementById(`sr-${pid}`);
  const sl=document.getElementById(`sl-${pid}`);
  if(sr) sr.innerHTML=[1,2,3,4,5].map(n=>`<button class="star${rating>=n?" on":""}" onclick="rate('${pid}',${n})">â˜…</button>`).join("");
  if(sl) sl.textContent=`Rated ${rating}/5`;
  if (currentUser && isNewUser) {
    await fetch(`${API}/api/interact`,{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user_id:currentUser,product_id:pid,rating})}).catch(()=>{});
    loadRecommendations();
  }
}

// â”€â”€ PAGE SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(page,btn) {
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  document.getElementById("page-shop").classList.toggle("hidden", page!=="shop");
  document.getElementById("page-purchased").style.display = page==="purchased" ? "block" : "none";
  if (page==="purchased") renderPurchased();
}
</script>
</body>
</html>
